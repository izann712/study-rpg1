<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SabioQuest â€” Completo (v2)</title>
<style>
/* ===========================
   SabioQuest â€” Estilo RPG (mobile-first)
   =========================== */
:root{
  --bg:#071028;
  --card:#0e1a2b;
  --muted:#9fb0d6;
  --accent:#4f7be6;
  --accent2:#8fb4ff;
  --gold:#ffd166;
  --success:#35d07f;
  --glass: rgba(255,255,255,0.03);
}
html,body{height:100%; margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(180deg,#071028 0%, #08132a 100%); color:#e6eefc;}
header{display:flex; align-items:center; justify-content:space-between; padding:16px; max-width:1100px; margin:0 auto;}
header h1{margin:0; font-size:18px; color:var(--accent2); letter-spacing:0.6px;}
header .sub{font-size:12px; color:var(--muted);}
main{max-width:1100px; margin:0 auto; padding:12px;}
.layout{display:grid; grid-template-columns:1fr; gap:12px;}
@media(min-width:980px){ .layout{grid-template-columns:2fr 380px;} header h1{font-size:20px;} }

.card{background:linear-gradient(180deg,var(--card), #071428); border-radius:12px; padding:12px; border:1px solid rgba(255,255,255,0.03); box-shadow: 0 6px 18px rgba(0,0,0,0.45);}
.row{display:flex; gap:8px; align-items:center;}
.row.space{justify-content:space-between;}
.muted{color:var(--muted); font-size:13px;}
.label{font-size:13px; color:var(--muted); margin-bottom:6px;}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2)); color:white; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600;}
.btn.secondary{background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted);}
.small{font-size:13px;}
.progressWrap{background:rgba(255,255,255,0.03); height:18px; border-radius:999px; overflow:hidden;}
.progressBar{height:100%; background:linear-gradient(90deg,var(--accent),var(--accent2)); width:0%; transition:width .5s ease;}
ul.missions{list-style:none; padding:0; margin:8px 0; display:flex; flex-direction:column; gap:8px;}
ul.missions li{display:flex; justify-content:space-between; align-items:center; gap:8px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.02);}
.mission-title{font-weight:700; font-size:15px;}
.mission-info{font-size:13px; color:var(--muted);}
.shop-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:8px;}
@media(min-width:600px){ .shop-grid{grid-template-columns:repeat(3,1fr);} }
.trophy{background:linear-gradient(180deg,#0f1b2c,#071427); border-radius:10px; padding:10px; border:1px solid rgba(255,255,255,0.03); text-align:center;}
.input, input, select, textarea{width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.01); color:inherit;}
.bottomNav{position:fixed; left:0; right:0; bottom:0; display:flex; gap:6px; padding:8px; background:linear-gradient(180deg, rgba(7,10,20,0.9), rgba(7,10,20,0.95)); justify-content:space-around; border-top:1px solid rgba(255,255,255,0.02);}
.navBtn{background:transparent; border:none; color:var(--muted); font-weight:700; padding:8px 10px; border-radius:10px;}
.navBtn.active{color:var(--accent2); background:rgba(79,123,230,0.06);}
.poke-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:8px;}
@media(min-width:600px){ .poke-grid{grid-template-columns:repeat(3,1fr);} }
.poke-card{background:linear-gradient(180deg,#071726,#0a1e35); padding:8px; border-radius:8px; text-align:center; border:1px solid rgba(255,255,255,0.02);}
footer{max-width:1100px; margin:14px auto; padding:12px; text-align:center; color:var(--muted); font-size:13px;}
.toast{position:fixed; left:50%; transform:translateX(-50%); bottom:88px; background:#071426; color:white; padding:10px 14px; border-radius:8px; display:none; z-index:9999; box-shadow:0 6px 24px rgba(0,0,0,0.6);}
</style>
</head>
<body>
<header>
  <div>
    <h1>SabioQuest</h1>
    <div class="muted">Tu RPG de estudio â€” 1Âº Bachillerato (3 trimestres)</div>
  </div>
  <div class="muted small">Niveliza & colecciona ðŸ¤“</div>
</header>

<main class="layout">
  <!-- MAIN COLUMN -->
  <div id="mainCol">
    <!-- PROFILE -->
    <section id="sectionProfile" class="card">
      <div class="row space">
        <div>
          <div class="label">Jugador</div>
          <div style="font-weight:800; font-size:18px;">Peregrino del Conocimiento</div>
          <div class="muted small">Clase: AcadÃ©mico Novato</div>
        </div>
        <div style="text-align:right;">
          <div class="muted small">ME</div>
          <div style="font-weight:800; font-size:18px;" id="meLabel">0</div>
        </div>
      </div>

      <hr style="border:none; height:8px; background:transparent">

      <div class="row">
        <div style="flex:1;">
          <div class="label">Nivel</div>
          <div style="font-weight:900; font-size:24px;" id="levelLabel">1</div>
        </div>
        <div style="flex:2;">
          <div class="label">Progreso</div>
          <div class="row" style="align-items:center;">
            <div style="flex:1;">
              <div class="progressWrap"><div id="xpBar" class="progressBar"></div></div>
            </div>
            <div style="width:80px; text-align:right; margin-left:8px;"><div id="xpLabel" class="small muted">0 / 100</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- DAILY MISSIONS -->
    <section id="sectionDaily" class="card">
      <div class="row space">
        <div>
          <h3 style="margin:0;">Misiones diarias</h3>
          <div class="muted small">Se generan 2â€“3 misiones al dÃ­a. Se regeneran automÃ¡ticamente al cambiar de dÃ­a.</div>
        </div>
        <div>
          <button class="btn secondary" id="btnRefreshDaily">Refrescar</button>
        </div>
      </div>
      <ul id="dailyList" class="missions" style="margin-top:12px;"></ul>
    </section>

    <!-- WEEKLY MISSIONS -->
    <section id="sectionWeekly" class="card">
      <div class="row space">
        <div>
          <h3 style="margin:0;">Misiones semanales</h3>
          <div class="muted small">2 misiones por semana. Se regeneran al comenzar nueva semana. Si completas todas, se regeneran inmediatamente.</div>
        </div>
        <div></div>
      </div>
      <ul id="weeklyList" class="missions" style="margin-top:12px;"></ul>
    </section>

    <!-- SPECIALS -->
    <section id="sectionSpecial" class="card">
      <h3 style="margin:0;">Misiones especiales</h3>
      <div class="muted small">Conjunto de desafÃ­os grandes. Al completar todas las misiones especiales, el conjunto se regenera.</div>
      <ul id="specialList" class="missions" style="margin-top:12px;"></ul>
    </section>

    <!-- EXAMS / GRADES -->
    <section id="sectionExams" class="card">
      <h3>Registrar examen</h3>
      <div class="muted small">Introduce asignatura y nota (0â€“10). RecibirÃ¡s XP = nota Ã— 5.</div>
      <div style="margin-top:8px;">
        <input id="inputSubject" placeholder="Asignatura (Ej: MatemÃ¡ticas)" />
        <div style="height:8px"></div>
        <input id="inputGrade" type="number" min="0" max="10" step="0.1" placeholder="Nota sobre 10" />
        <div style="height:8px"></div>
        <div class="row">
          <button class="btn" id="btnSaveGrade">Guardar nota</button>
          <button class="btn secondary" id="btnShowGrades">Ver historial</button>
        </div>
      </div>

      <div id="gradesList" style="margin-top:12px;"></div>
    </section>
  </div>

  <!-- SIDEBAR -->
  <aside id="sideCol">
    <section id="sectionShop" class="card">
      <h3>Tienda â€” Trofeos</h3>
      <div class="muted small">Compra trofeos con ME (desaparecen de la tienda al comprarlos).</div>
      <div id="shopGrid" class="shop-grid" style="margin-top:10px;"></div>
    </section>

    <section id="sectionInventory" class="card" style="margin-top:12px;">
      <h3>Tu colecciÃ³n</h3>
      <div class="muted small">Trofeos y logros que has comprado.</div>
      <div id="inventoryGrid" style="margin-top:10px;"></div>
    </section>

    <section id="sectionPokedex" class="card" style="margin-top:12px;">
      <h3>PokÃ©dex</h3>
      <div class="muted small">PokÃ©mon raros conseguidos (solo nombres, sin imÃ¡genes).</div>
      <div id="pokedexGrid" class="poke-grid" style="margin-top:10px;"></div>
    </section>
  </aside>
</main>

<div class="bottomNav">
  <button class="navBtn active" data-target="sectionProfile">Ficha</button>
  <button class="navBtn" data-target="sectionDaily">Diarias</button>
  <button class="navBtn" data-target="sectionWeekly">Semanales</button>
  <button class="navBtn" data-target="sectionShop">Tienda</button>
  <button class="navBtn" data-target="sectionPokedex">PokÃ©mon</button>
</div>

<div id="toast" class="toast"></div>
<footer>SabioQuest â€” guarda en localStorage â€¢ DiseÃ±ado para mÃ³vil</footer>

<script>
/* ===========================
   SabioQuest â€” LÃ³gica extensa
   =========================== */

/* ---------- CONFIGURACIÃ“N (pools, precios, probabilidades) ---------- */

/* Misiones diarias: objetos con id, title, xp, me, info */
const DAILY_POOL = [
  {id:'d01', title:'RevisiÃ³n rÃ¡pida (15 min)', xp:10, me:1, info:'Repasar 15 minutos un tema ya visto.'},
  {id:'d02', title:'Orden del escritorio', xp:8, me:0, info:'Organiza tus apuntes y materiales.'},
  {id:'d03', title:'Hacer 5 ejercicios', xp:15, me:1, info:'Resolver 5 ejercicios del tema.'},
  {id:'d04', title:'Leer 10 pÃ¡ginas', xp:12, me:0, info:'Lectura para comprensiÃ³n.'},
  {id:'d05', title:'Mini-resumen 5 lÃ­neas', xp:12, me:0, info:'Escribe un resumen de 5 lÃ­neas.'},
  {id:'d06', title:'Repasar apuntes', xp:10, me:0, info:'Repasa apuntes recientes.'},
  {id:'d07', title:'Resolver dudas pendientes', xp:14, me:0, info:'Resolver dudas por cuenta propia o con ayuda.'},
  {id:'d08', title:'Preparar agenda del dÃ­a', xp:8, me:0, info:'Planifica tu jornada de estudio.'},
  {id:'d09', title:'Repasar fÃ³rmulas', xp:10, me:0, info:'Repaso de fÃ³rmulas clave.'},
  {id:'d10', title:'Leer un artÃ­culo educativo', xp:12, me:0, info:'Leer una entrada o artÃ­culo educativo.'},
  {id:'d11', title:'Crear 5 flashcards', xp:12, me:0, info:'Crear tarjetas de repaso.'},
  {id:'d12', title:'Practicar problemas', xp:15, me:0, info:'Practicar ejercicios tipo examen.'},
  {id:'d13', title:'EnseÃ±ar 10 min a un amigo', xp:20, me:1, info:'Explica un concepto a otra persona.'},
  {id:'d14', title:'Escuchar podcast educativo 20 min', xp:12, me:0, info:'Escuchar contenido formativo.'},
  {id:'d15', title:'Actividad de memoria', xp:10, me:0, info:'Flashcards o ejercicios de memoria.'}
];

/* Misiones semanales */
const WEEKLY_POOL = [
  {id:'w01', title:'DesafÃ­o de comprensiÃ³n', xp:30, me:3, info:'Estudia 1h y haz un resumen.'},
  {id:'w02', title:'Mejorador de deberes', xp:25, me:2, info:'Entrega tarea revisada y mejorada.'},
  {id:'w03', title:'Proyecto del peregrino', xp:40, me:4, info:'Avanza notablemente en un proyecto.'},
  {id:'w04', title:'Autoexamen 10 preguntas', xp:35, me:2, info:'Crea y responde un test propio.'},
  {id:'w05', title:'Mapa mental de un tema', xp:30, me:0, info:'Crear mapa mental para repasar.'},
  {id:'w06', title:'Organizar apuntes de la semana', xp:35, me:0, info:'Ordenar y sintetizar apuntes.'},
  {id:'w07', title:'Estudiar 2 horas acumuladas', xp:50, me:0, info:'Acumular 2 horas de estudio real.'},
  {id:'w08', title:'Completar un trabajo pendiente', xp:45, me:0, info:'Finalizar trabajo atrasado.'},
  {id:'w09', title:'SesiÃ³n en biblioteca', xp:40, me:0, info:'Estudiar en ambiente serio.'},
  {id:'w10', title:'Preparar una presentaciÃ³n', xp:38, me:2, info:'Preparar y ensayar presentaciÃ³n corta.'}
];

/* Misiones especiales: se regeneran cuando se completan todas */
const SPECIAL_POOL = [
  {id:'s01', title:'Mini-examen 15 preguntas', xp:60, me:5, info:'Simula 15 preguntas.'},
  {id:'s02', title:'Guardia del conocimiento 90 min', xp:70, me:0, info:'90 minutos sin distracciones.'},
  {id:'s03', title:'MaratÃ³n 2 horas', xp:80, me:0, info:'2 horas concentradas.'},
  {id:'s04', title:'Explicar un tema a alguien', xp:50, me:0, info:'EnseÃ±ar a otra persona.'},
  {id:'s05', title:'Resumen maestro', xp:65, me:0, info:'Resumen extenso de una unidad.'},
  {id:'s06', title:'SimulaciÃ³n examen 1h', xp:90, me:10, info:'Simular examen real durante 1h.'}
];

/* Tienda de trofeos: al comprar se eliminan de la tienda y se aÃ±aden al inventario */
const TROPHIES = [
  {id:'t1', name:'Trofeo del Primer Paso', price:15, desc:'Recuerdo del inicio de tu aventura.'},
  {id:'t2', name:'Medalla de la Constancia', price:40, desc:'Por estudiar todos los dÃ­as.'},
  {id:'t3', name:'Insignia de la ConcentraciÃ³n', price:80, desc:'Por grandes sesiones de estudio.'},
  {id:'t4', name:'Cetro de la Memoria', price:150, desc:'SÃ­mbolo de retenciÃ³n.'},
  {id:'t5', name:'Corona del Sabio', price:300, desc:'Trofeo Ã©pico.'}
];

/* POKÃ‰MON: 50 nombres graciosos (solo nombres; no imÃ¡genes) */
const POKEMON_POOL = [
  'Patatamon','Chorizord','Perritotron','GateteVolador','ConejoRÃ­tmico','TomatÃ³n','Pepinator','BananaShock','Flamencornio','Quesodrilo',
  'Pupipollo','FantasPez','Perrumbo','Gatostroncio','Limonacho','Huesofante','Tortillazor','CebollÃ­n','Tronchacabra','RatoncinTurbo',
  'CroquetaX','BocataDrake','Zumoneta','TostaRex','FideoFielder','Melonita','BrocoliBoom','CactusÃ­n','Solomillo','PlatanoZ',
  'Tijeretazo','Globofante','MofleteMÃ¡gico','Zarzamora','Milanesaur','Chicletron','NubeSosa','CarbÃ³nito','Aguacatron','PastaNova',
  'Galletor','Espaguetti','Mermelucho','BombÃ³nix','Siropeus','Gelatinor','PepinilloFiero','Mielrayo','NudlÃ­n','Kebabito'
];

/* Probabilidad de conseguir un PokÃ©mon al completar misiÃ³n: muy baja */
const POKE_CHANCE = 0.005; // 0.5%

/* ---------- ALMACENAMIENTO (localStorage) ---------- */
const KEY = (k)=>`sabioquest_v2_${k}`;
function save(key, value){ localStorage.setItem(KEY(key), JSON.stringify(value)); }
function load(key, fallback=null){ const v = localStorage.getItem(KEY(key)); return v ? JSON.parse(v) : fallback; }

/* ---------- ESTADO INICIAL ---------- */
let state = {
  level: 1,
  xp: 0,
  xpNeeded: 100, // incrementarÃ¡ +10 por nivel
  me: 20,
  daily: [],     // objetos de misiones diarias actuales
  weekly: [],    // objetos de misiones semanales actuales
  special: [],   // copias de SPECIAL_POOL, regenerables
  inventory: [], // trofeos comprados (ids)
  grades: [],    // {subject, grade}
  pokedex: [],   // ids (nombres) de pokÃ©mon obtenidos
  lastDayKey: null,
  lastWeekKey: null
};

/* Cargar estado guardado (si lo hay) */
function loadState(){
  const s = load('state', null);
  if(s){
    // merge (seguro)
    state = Object.assign(state, s);
    // ensure xpNeeded present
    if(!state.xpNeeded) state.xpNeeded = 100;
  } else {
    // first time: init special as copy
    state.special = SPECIAL_POOL.map(m => Object.assign({}, m));
  }
}
loadState();

/* ---------- FECHAS: identificar dÃ­a y semana actual ---------- */
function getDayKey(date = new Date()){
  const start = new Date(date.getFullYear(), 0, 0);
  const diff = date - start + ((start.getTimezoneOffset() - date.getTimezoneOffset()) * 60000);
  const oneDay = 1000 * 60 * 60 * 24;
  const dayOfYear = Math.floor(diff / oneDay);
  return `${date.getFullYear()}_${dayOfYear}`;
}
function getISOWeekKey(date = new Date()){
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
  return `${d.getUTCFullYear()}_W${weekNo}`;
}

/* ---------- UTIL: pick N unique ---------- */
function pickRandomUnique(pool, n){
  const a = pool.slice();
  const out = [];
  for(let i=0;i<n && a.length>0;i++){
    const idx = Math.floor(Math.random()*a.length);
    out.push(a.splice(idx,1)[0]);
  }
  return out;
}

/* ---------- REGENERACIÃ“N AUTOMÃTICA ---------- */
function ensureMissionsCurrent(){
  const todayKey = getDayKey();
  const weekKey = getISOWeekKey();

  // DAILY: if day changed or missing -> regenerate 2â€“3
  if(!state.lastDayKey || state.lastDayKey !== todayKey){
    const count = Math.random() < 0.6 ? 2 : 3; // 60% 2, 40% 3
    state.daily = pickRandomUnique(DAILY_POOL, count);
    state.lastDayKey = todayKey;
  } else {
    if(!state.daily || state.daily.length === 0) {
      const count = Math.random() < 0.6 ? 2 : 3;
      state.daily = pickRandomUnique(DAILY_POOL, count);
    }
  }

  // WEEKLY: if week changed or missing -> regenerate 2
  if(!state.lastWeekKey || state.lastWeekKey !== weekKey){
    state.weekly = pickRandomUnique(WEEKLY_POOL, 2);
    state.lastWeekKey = weekKey;
  } else {
    if(!state.weekly || state.weekly.length === 0){
      state.weekly = pickRandomUnique(WEEKLY_POOL, 2);
    }
  }

  // SPECIAL: if all completed -> regenerate whole set
  if(!state.special || state.special.length === 0){
    state.special = SPECIAL_POOL.map(m => Object.assign({}, m));
  }

  saveState();
}

/* ---------- GUARDAR / CARGAR ---------- */
function saveState(){
  // only store data we need
  save('state', {
    level: state.level,
    xp: state.xp,
    xpNeeded: state.xpNeeded,
    me: state.me,
    daily: state.daily,
    weekly: state.weekly,
    special: state.special,
    inventory: state.inventory,
    grades: state.grades,
    pokedex: state.pokedex,
    lastDayKey: state.lastDayKey,
    lastWeekKey: state.lastWeekKey
  });
}

/* ---------- LEVEL / XP logic (+10 per level) ---------- */
function checkLevelUp(){
  let leveled = false;
  while(state.xp >= state.xpNeeded){
    state.xp -= state.xpNeeded;
    state.level += 1;
    state.xpNeeded += 10; // <-- incremento +10 por nivel (tu peticiÃ³n)
    leveled = true;
    showToast(`Â¡Subiste al nivel ${state.level}!`);
  }
  if(leveled) saveState();
}

/* ---------- UI RENDERERS ---------- */
const $ = (id)=> document.getElementById(id);

function renderProfile(){
  $('levelLabel').textContent = state.level;
  $('xpLabel').textContent = `${state.xp} / ${state.xpNeeded}`;
  $('meLabel').textContent = state.me;
  const pct = Math.round((state.xp / state.xpNeeded) * 100);
  $('xpBar').style.width = Math.min(100, pct) + '%';
}

/* Render missions lists */
function renderMissions(){
  // Daily
  const dailyList = $('dailyList');
  dailyList.innerHTML = '';
  state.daily.forEach((m, i)=>{
    const li = document.createElement('li');
    li.innerHTML = `<div>
        <div class="mission-title">${m.title}</div>
        <div class="mission-info">${m.info}</div>
      </div>
      <div style="text-align:right;">
        <div class="muted small">${m.xp} XP ${m.me ? 'Â· ' + m.me + ' ME' : ''}</div>
        <div style="height:8px"></div>
        <button class="btn" onclick="completeMission('daily', ${i})">Completar</button>
      </div>`;
    dailyList.appendChild(li);
  });

  // Weekly
  const weeklyList = $('weeklyList');
  weeklyList.innerHTML = '';
  state.weekly.forEach((m, i)=>{
    const li = document.createElement('li');
    li.innerHTML = `<div>
        <div class="mission-title">${m.title}</div>
        <div class="mission-info">${m.info}</div>
      </div>
      <div style="text-align:right;">
        <div class="muted small">${m.xp} XP ${m.me ? 'Â· ' + m.me + ' ME' : ''}</div>
        <div style="height:8px"></div>
        <button class="btn" onclick="completeMission('weekly', ${i})">Completar</button>
      </div>`;
    weeklyList.appendChild(li);
  });

  // Special
  const specialList = $('specialList');
  specialList.innerHTML = '';
  state.special.forEach((m, i)=>{
    const li = document.createElement('li');
    li.innerHTML = `<div>
        <div class="mission-title">${m.title}</div>
        <div class="mission-info">${m.info}</div>
      </div>
      <div style="text-align:right;">
        <div class="muted small">${m.xp} XP ${m.me ? 'Â· ' + m.me + ' ME' : ''}</div>
        <div style="height:8px"></div>
        <button class="btn" onclick="completeMission('special', ${i})">Completar</button>
      </div>`;
    specialList.appendChild(li);
  });
}

/* Render shop */
function renderShop(){
  const grid = $('shopGrid');
  grid.innerHTML = '';
  const available = TROPHIES.filter(t => !state.inventory.includes(t.id));
  if(available.length === 0){
    grid.innerHTML = `<div class="muted">La tienda estÃ¡ vacÃ­a â€” ya compraste todo.</div>`;
    return;
  }
  available.forEach(t=>{
    const div = document.createElement('div');
    div.className = 'trophy';
    div.innerHTML = `<h4 style="margin:6px 0;">${t.name}</h4><div class="muted small" style="margin-bottom:8px;">${t.desc}</div>
      <div class="row space"><div class="muted">${t.price} ME</div><button class="btn" onclick="buyTrophy('${t.id}')">Comprar</button></div>`;
    grid.appendChild(div);
  });
}

/* Render inventory (trofeos comprados) */
function renderInventory(){
  const inv = $('inventoryGrid');
  inv.innerHTML = '';
  if(state.inventory.length === 0){
    inv.innerHTML = `<div class="muted">AÃºn no tienes trofeos. Compra en la tienda.</div>`;
    return;
  }
  state.inventory.forEach(id => {
    const t = TROPHIES.find(x => x.id === id);
    if(!t) return;
    const d = document.createElement('div');
    d.className = 'trophy';
    d.style.textAlign = 'left';
    d.innerHTML = `<h4 style="margin:0">${t.name}</h4><div class="muted small">${t.desc}</div><div style="height:6px"></div><div style="font-size:12px;color:var(--muted)">Comprado</div>`;
    inv.appendChild(d);
  });
}

/* Render pokedex */
function renderPokedex(){
  const grid = $('pokedexGrid');
  grid.innerHTML = '';
  if(state.pokedex.length === 0){
    grid.innerHTML = `<div class="muted">No has conseguido PokÃ©mon aÃºn â€” Â¡suerte!</div>`;
    return;
  }
  state.pokedex.forEach(pid => {
    const p = POKEMON_POOL.find(x => x === pid);
    const elP = document.createElement('div');
    elP.className = 'poke-card';
    elP.innerHTML = `<div style="font-weight:700">${p}</div><div class="muted small">Coleccionado</div>`;
    grid.appendChild(elP);
  });
}

/* Render grades */
function renderGrades(){
  const container = $('gradesList');
  if(!state.grades || state.grades.length === 0){
    container.innerHTML = `<div class="muted">No hay notas registradas.</div>`;
    return;
  }
  container.innerHTML = state.grades.map(g => {
    return `<div style="padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); margin-bottom:6px;"><strong>${escapeHtml(g.subject)}</strong> â€” Nota: ${g.grade}/10</div>`;
  }).join('');
}

/* ---------- ACCIONES: completar misiones, comprar trofeos, guardar exÃ¡menes ---------- */

/* Intento de captura de PokÃ©mon con probabilidad POKE_CHANCE */
function tryCatchPokemon(){
  if(Math.random() < POKE_CHANCE){
    const available = POKEMON_POOL.filter(name => !state.pokedex.includes(name));
    if(available.length === 0) return; // ya los tienes todos
    const pick = available[Math.floor(Math.random()*available.length)];
    state.pokedex.push(pick);
    showToast(`Â¡Has conseguido un PokÃ©mon: ${pick}!`);
    saveState();
  }
}

/* Completar misiÃ³n generalizada */
function completeMission(type, index){
  if(type === 'daily'){
    const m = state.daily[index];
    if(!m) return;
    state.xp += m.xp;
    state.me += m.me || 0;
    state.daily.splice(index,1);
    showToast(`MisiÃ³n completada: +${m.xp} XP${m.me? ' Â· +' + m.me + ' ME' : ''}`);
    tryCatchPokemon();
  } else if(type === 'weekly'){
    const m = state.weekly[index];
    if(!m) return;
    state.xp += m.xp;
    state.me += m.me || 0;
    state.weekly.splice(index,1);
    showToast(`MisiÃ³n semanal completada: +${m.xp} XP`);
    // if all weekly done -> regenerate new weekly set immediately
    if(state.weekly.length === 0){
      state.weekly = pickRandomUnique(WEEKLY_POOL, 2);
      showToast('Se han regenerado nuevas misiones semanales.');
    }
    tryCatchPokemon();
  } else if(type === 'special'){
    const m = state.special[index];
    if(!m) return;
    state.xp += m.xp;
    state.me += m.me || 0;
    state.special.splice(index,1);
    showToast(`MisiÃ³n especial completada: +${m.xp} XP`);
    // if all special completed, regenerate the full special pool
    if(state.special.length === 0){
      state.special = SPECIAL_POOL.map(x => Object.assign({}, x));
      showToast('Las misiones especiales se han regenerado.');
    }
    tryCatchPokemon();
  }
  checkLevelUp();
  saveState();
  renderAll();
}

/* Comprar trofeo */
function buyTrophy(tid){
  const t = TROPHIES.find(x => x.id === tid);
  if(!t) return;
  if(state.inventory.includes(tid)){
    showToast('Ya tienes ese trofeo.');
    return;
  }
  if(state.me < t.price){
    showToast('No tienes suficientes ME.');
    return;
  }
  state.me -= t.price;
  state.inventory.push(tid);
  showToast(`Comprado: ${t.name}`);
  saveState();
  renderAll();
}

/* Guardar nota (examen): XP = grade * 5 */
function saveGrade(){
  const subject = $('inputSubject').value.trim();
  const grade = parseFloat($('inputGrade').value);
  if(!subject || isNaN(grade) || grade < 0 || grade > 10){
    showToast('Introduce asignatura y nota vÃ¡lida (0â€“10).');
    return;
  }
  const rounded = Math.round(grade*10)/10;
  state.grades.push({subject, grade: rounded});
  const xpGain = Math.round(rounded * 5);
  state.xp += xpGain;
  showToast(`Nota registrada: +${xpGain} XP`);
  $('inputSubject').value = '';
  $('inputGrade').value = '';
  checkLevelUp();
  saveState();
  renderAll();
}

/* ---------- HELPERS ---------- */
function showToast(msg, timeout = 3000){
  const t = $('toast');
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(t._t);
  t._t = setTimeout(()=> t.style.display = 'none', timeout);
}
function escapeHtml(s){ return String(s).replace(/[&<"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','"':'&quot;',"'":'&#039;'}[m]); }); }

/* ---------- RENDER ALL ---------- */
function renderAll(){
  renderProfile();
  renderMissions();
  renderShop();
  renderInventory();
  renderPokedex();
  renderGrades();
}

/* ---------- MANUAL CONTROLS ---------- */
$('btnRefreshDaily')?.addEventListener('click', ()=>{
  state.daily = pickRandomUnique(DAILY_POOL, Math.random() < 0.6 ? 2 : 3);
  saveState();
  renderAll();
  showToast('Misiones diarias regeneradas (manual).');
});
$('btnSaveGrade')?.addEventListener('click', saveGrade);
$('btnShowGrades')?.addEventListener('click', ()=> { $('gradesList').scrollIntoView({behavior:'smooth'}); });

/* ---------- NAV BOTTOM ---------- */
document.querySelectorAll('.navBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.navBtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const target = btn.getAttribute('data-target');
    if(target){
      // scroll to the section smoothly
      const elTarget = document.getElementById(target);
      if(elTarget) window.scrollTo({top: elTarget.offsetTop - 12, behavior:'smooth'});
    }
  });
});

/* ---------- INIT: ensure missions and render ---------- */
ensureMissionsCurrent();
saveState();
renderAll();

/* ---------- Expose for debugging in console (optional) ---------- */
window.SQ = {
  state,
  saveState,
  loadState,
  ensureMissionsCurrent,
  completeMission,
  buyTrophy,
  saveGrade,
  pickRandomUnique
};
</script>
</body>
</html>
